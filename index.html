<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>뉴스 요약 챗봇 (Gemini 1.5 Flash)</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: "Malgun Gothic", "Apple SD Gothic Neo", sans-serif;
      max-width: 720px;
      margin: 0 auto;
      padding: 24px 16px;
      background: #f5f5f5;
      color: #222;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 8px;
      color: #1a1a2e;
    }
    .sub {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 24px;
    }
    .api-box {
      margin-bottom: 16px;
      padding: 10px 12px;
      background: #e5f3ff;
      border-radius: 8px;
      border: 1px solid #bfdbfe;
      font-size: 0.85rem;
      color: #1e3a8a;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .api-box label { font-weight: 600; }
    .api-box input {
      flex: 1;
      min-width: 180px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #93c5fd;
      font-size: 0.85rem;
    }
    .search-box {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }
    .search-box input {
      flex: 1;
      padding: 12px 14px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
    }
    .search-box input:focus {
      outline: none;
      border-color: #2563eb;
    }
    .search-box button {
      padding: 12px 20px;
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
    }
    .search-box button:hover { background: #1d4ed8; }
    .search-box button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }
    .message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .message.loading { background: #e0f2fe; color: #0369a1; }
    .message.error { background: #fee2e2; color: #b91c1c; }
    .message.empty { background: #fef3c7; color: #92400e; }
    .result-header {
      font-size: 0.95rem;
      color: #475569;
      margin-bottom: 16px;
    }
    .article {
      background: #fff;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .article h3 {
      margin: 0 0 8px 0;
      font-size: 1.05rem;
      line-height: 1.4;
    }
    .article h3 a {
      color: #1e293b;
      text-decoration: none;
    }
    .article h3 a:hover { text-decoration: underline; }
    .article .meta {
      font-size: 0.8rem;
      color: #64748b;
      margin-bottom: 8px;
    }
    .summary-section {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .summary-section h2 {
      font-size: 1rem;
      margin: 0 0 10px 0;
      color: #0369a1;
    }
    .summary-section .overview {
      font-size: 0.9rem;
      color: #0c4a6e;
      line-height: 1.6;
      margin-bottom: 10px;
    }
    .summary-section .headlines {
      font-size: 0.85rem;
      color: #475569;
      padding-left: 1.2rem;
      line-height: 1.5;
    }
    .summary-section .headlines li { margin-bottom: 4px; }
    .article .summary-block {
      margin-top: 10px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 3px solid #2563eb;
    }
    .article .summary-block .label {
      font-size: 0.75rem;
      font-weight: bold;
      color: #2563eb;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    .article .summary {
      font-size: 0.9rem;
      color: #475569;
      line-height: 1.5;
      margin: 0;
    }
    .article .summary br { display: none; }
    .article .summary-loading {
      color: #64748b;
      font-size: 0.85rem;
      font-style: italic;
    }
    .article .summary-fail {
      color: #94a3b8;
      font-size: 0.85rem;
    }
    .ai-section {
      margin-top: 20px;
      padding: 14px;
      background: #f1f5f9;
      border-radius: 10px;
      border: 1px solid #cbd5f5;
    }
    .ai-section h2 {
      font-size: 1rem;
      margin: 0 0 8px 0;
      color: #0f172a;
    }
    .ai-summary-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .ai-summary-actions button {
      padding: 6px 10px;
      font-size: 0.85rem;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: #fff;
      cursor: pointer;
    }
    .ai-summary-actions button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .ai-summary-content {
      font-size: 0.9rem;
      color: #111827;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    .chat-section {
      margin-top: 24px;
      padding: 14px;
      border-radius: 10px;
      border: 1px solid #d4d4d8;
      background: #fafafa;
    }
    .chat-section h2 {
      font-size: 1rem;
      margin: 0 0 8px 0;
      color: #111827;
    }
    .chat-messages {
      max-height: 260px;
      overflow-y: auto;
      padding: 8px;
      margin-bottom: 10px;
      background: #ffffff;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      font-size: 0.9rem;
    }
    .chat-message {
      margin-bottom: 8px;
      line-height: 1.4;
    }
    .chat-message.user {
      text-align: right;
      color: #1d4ed8;
      font-weight: bold;
    }
    .chat-message.bot {
      text-align: left;
      color: #111827;
    }
    .chat-input-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }
    .chat-input-row input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d4d4d8;
      font-size: 0.9rem;
    }
    .chat-input-row button {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      font-size: 0.9rem;
      background: #2563eb;
      color: #fff;
      cursor: pointer;
    }
    .chat-input-row button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .history {
      margin-top: 18px;
      font-size: 0.8rem;
      color: #4b5563;
    }
    .history ul {
      padding-left: 1.2rem;
      margin: 4px 0 0 0;
    }
    .history li {
      cursor: pointer;
      text-decoration: underline;
      margin-bottom: 2px;
    }
  </style>
</head>
<body>
  <h1>뉴스 요약 챗봇</h1>
  <p class="sub">키워드를 입력하면 구글 뉴스에서 관련 뉴스 10개를 찾아, AI로 요약하고 대화할 수 있어요.</p>

  <div class="api-box">
    <label for="apiKey">Gemini API 키</label>
    <input type="password" id="apiKey" placeholder="Vercel 배포 시 비워두세요 (환경변수 사용). 로컬에서만 입력" value="">
  </div>

  <div class="search-box">
    <input type="text" id="keyword" placeholder="검색할 키워드 입력 (예: 인공지능, 삼성전자)" autofocus>
    <button type="button" id="searchBtn">검색</button>
  </div>

  <div id="message" class="message" style="display: none;"></div>
  <div id="result"></div>

  <div id="aiSummarySection" class="ai-section" style="display:none;">
    <h2>AI 전체 요약</h2>
    <div class="ai-summary-actions">
      <button type="button" id="aiSummaryBtn">뉴스를 AI로 요약하기</button>
      <span id="aiSummaryStatus" style="font-size:0.8rem;color:#6b7280;"></span>
    </div>
    <div id="aiSummaryContent" class="ai-summary-content"></div>
  </div>

  <div id="chatSection" class="chat-section" style="display:none;">
    <h2>뉴스와 대화하기</h2>
    <p style="font-size:0.8rem;color:#6b7280;margin:0 0 6px 0;">
      위에서 수집한 뉴스 내용을 바탕으로 궁금한 것을 물어보세요.
    </p>
    <div id="chatMessages" class="chat-messages"></div>
    <div class="chat-input-row">
      <input type="text" id="chatInput" placeholder="예: 이 뉴스들의 공통된 흐름이 뭐야?">
      <button type="button" id="chatSendBtn">질문 보내기</button>
    </div>
  </div>

  <div id="historySection" class="history">
    <strong>최근 검색 키워드</strong>
    <ul id="historyList"></ul>
  </div>

  <script>
    (function () {
      var GOOGLE_NEWS_RSS = "https://news.google.com/rss/search";
      // CORS 프록시 옵션들 (무료 프록시는 불안정할 수 있으니 여러 개 사용)
      var CORS_PROXIES = [
        "https://corsproxy.io/?",
        "https://api.allorigins.win/raw?url=",
        "https://api.codetabs.com/v1/proxy?quest="
      ];
      var currentProxyIndex = 0;
      var MAX_RESULTS = 10;
      
      function getCorsProxy() {
        return CORS_PROXIES[currentProxyIndex];
      }
      
      function tryNextProxy() {
        currentProxyIndex = (currentProxyIndex + 1) % CORS_PROXIES.length;
        console.log("다음 프록시로 전환:", getCorsProxy());
      }
      
      // 공식 문서 기준 사용 가능 모델 (gemini-2.5-flash: 텍스트 입력/출력, 안정 버전)
      var GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";

      var currentArticles = [];
      var currentKeyword = "";
      var chatHistory = []; 
      var STORAGE_KEY = "news_chatbot_history_v1";

      function buildRssUrl(query) {
        var params = new URLSearchParams({
          q: query,
          hl: "kr-ko",
          gl: "KR",
          ceid: "KR:ko"
        });
        return GOOGLE_NEWS_RSS + "?" + params.toString();
      }

      function stripHtml(html) {
        if (!html) return "";
        var tmp = document.createElement("div");
        tmp.innerHTML = html;
        return (tmp.textContent || tmp.innerText || "").trim();
      }

      function extractMainText(html) {
        if (!html || html.length < 100) return "";
        var parser = new DOMParser();
        var doc = parser.parseFromString(html, "text/html");
        if (!doc.body) return "";
        
        // 불필요한 태그 제거
        var kill = doc.querySelectorAll("script, style, noscript, iframe, nav, header, footer, aside, [role=navigation], .ad, .ads, .advertisement, #comments");
        for (var i = 0; i < kill.length; i++) kill[i].parentNode.removeChild(kill[i]);
        
        // 본문 추정
        var main = doc.querySelector("article, [role=main], main, .article-body, .post-body, .content, .entry-content, .news_body, .article_content");
        var root = main || doc.body;
        
        var text = (root.textContent || "").replace(/\s+/g, " ").trim();
        return text.length > 50 ? text : (doc.body.textContent || "").replace(/\s+/g, " ").trim();
      }

      function extractiveSummarize(text, maxSentences) {
        maxSentences = maxSentences || 3;
        if (!text || text.length < 20) return "";
        var sentences = text.split(/(?<=[.!?。？！])\s+/).filter(function (s) {
          var t = s.trim();
          return t.length > 15 && t.length < 500;
        });
        if (sentences.length === 0) {
          var fallback = text.slice(0, 400).trim();
          return fallback + (text.length > 400 ? "…" : "");
        }
        var scored = sentences.slice(0, 15).map(function (s, i) {
          return { text: s.trim(), score: 1 - i / 15 };
        });
        scored.sort(function (a, b) { return b.score - a.score; });
        var top = scored.slice(0, maxSentences).map(function (x) { return x.text; }).join(" ");
        return top.length > 600 ? top.slice(0, 597) + "…" : top;
      }

      function escapeHtml(s) {
        if (!s) return "";
        var div = document.createElement("div");
        div.textContent = s;
        return div.innerHTML;
      }

      function showMessage(text, type) {
        var el = document.getElementById("message");
        el.textContent = text;
        el.className = "message " + (type || "");
        el.style.display = "block";
      }

      function hideMessage() {
        document.getElementById("message").style.display = "none";
      }

      function buildSummarySection(keyword, articles) {
        var headlines = articles.map(function (a) { return a.title; });
        var listItems = headlines.map(function (t) { return "<li>" + escapeHtml(t) + "</li>"; }).join("");
        return (
          "<div class=\"summary-section\">" +
          "<h2>이번 뉴스 요약</h2>" +
          "<p class=\"overview\">'" + escapeHtml(keyword) + "' 관련 뉴스 " + articles.length + "건입니다. 각 기사는 본문과 요약을 바탕으로 AI와 대화할 수 있습니다.</p>" +
          "<ul class=\"headlines\">" + listItems + "</ul>" +
          "</div>"
        );
      }

      function showResult(keyword, articles) {
        var container = document.getElementById("result");
        if (!articles.length) {
          container.innerHTML = "";
          showMessage("관련 뉴스를 찾지 못했어요. 키워드를 바꿔서 다시 시도해 주세요.", "empty");
          return;
        }

        hideMessage();
        var summarySection = buildSummarySection(keyword, articles);
        var header = "<p class=\"result-header\">총 " + articles.length + "개의 뉴스를 찾았어요.</p>";
        var listHtml = articles.map(function (a, i) {
          var title = a.title;
          var safeTitle = escapeHtml(title);
          var safeLink = a.link || "";
          var link = safeLink ? ("<a href=\"" + safeLink + "\" target=\"_blank\" rel=\"noopener\">" + safeTitle + "</a>") : safeTitle;
          var meta = a.published ? "<span class=\"meta\">" + escapeHtml(a.published) + "</span>" : "";
          var summaryBlockId = "summary_block_" + i;
          var summaryBlock = (
            "<div class=\"summary-block\" id=\"" + summaryBlockId + "\" data-summary-block=\"" + i + "\">" +
            "<div class=\"label\">본문 기반 요약</div>" +
            "<p class=\"summary summary-loading\">본문을 읽고 요약하는 중…</p>" +
            "</div>"
          );
          return (
            "<article class=\"article\" data-article-index=\"" + i + "\" data-link=\"" + escapeHtml(safeLink) + "\">" +
            "<h3>" + (i + 1) + ". " + link + "</h3>" +
            meta +
            summaryBlock +
            "</article>"
          );
        }).join("");
        container.innerHTML = summarySection + header + listHtml;

        // 본문 기반 요약 (간단 추출 요약)
        articles.forEach(function (a, i) {
          var articleEl = container.querySelector(".article[data-article-index=\"" + i + "\"]");
          if (!articleEl || !a.link) return;
          var block = articleEl.querySelector(".summary-block");
          var fallback = a.summary ? stripHtml(a.summary) : "";
          fetchArticleAndSummarize(a.link, block, fallback);
        });

        // AI/대화 섹션 준비
        currentArticles = articles;
        currentKeyword = keyword;
        chatHistory = [];
        document.getElementById("aiSummarySection").style.display = "block";
        document.getElementById("chatSection").style.display = "block";
        document.getElementById("aiSummaryContent").textContent = "";
        document.getElementById("aiSummaryStatus").textContent = "";
        document.getElementById("chatMessages").innerHTML = "";

        saveHistory(keyword, articles);
        renderHistory();
      }

      function setLoading(loading) {
        var btn = document.getElementById("searchBtn");
        btn.disabled = loading;
        if (loading) {
          showMessage("뉴스를 검색 중입니다. 잠시만 기다려 주세요...", "loading");
        } else {
          hideMessage();
        }
      }

      document.getElementById("searchBtn").addEventListener("click", doSearch);
      document.getElementById("keyword").addEventListener("keydown", function (e) {
        if (e.key === "Enter") doSearch();
      });

      document.getElementById("aiSummaryBtn").addEventListener("click", handleAiSummary);
      document.getElementById("chatSendBtn").addEventListener("click", handleChatSend);
      document.getElementById("chatInput").addEventListener("keydown", function (e) {
        if (e.key === "Enter") handleChatSend();
      });

      function doSearch() {
        var keyword = document.getElementById("keyword").value.trim();
        if (!keyword) return;

        setLoading(true);
        document.getElementById("result").innerHTML = "";

        var rssUrl = buildRssUrl(keyword);
        
        function fetchRss() {
          var proxyUrl = getCorsProxy() + encodeURIComponent(rssUrl);
          return fetch(proxyUrl, { 
            mode: 'cors',
            cache: 'no-cache'
          })
            .then(function (res) {
              if (!res.ok) throw new Error("HTTP " + res.status);
              return res.text();
            })
            .catch(function (err) {
              console.warn("프록시 오류:", err);
              if (currentProxyIndex < CORS_PROXIES.length - 1) {
                tryNextProxy();
                return fetchRss(); // 재시도
              }
              // 모든 프록시 실패 시 직접 호출 시도 (최후의 수단)
              return fetch(rssUrl, { mode: 'no-cors' })
                .then(function(res) { return res.text(); })
                .catch(function() {
                  throw new Error("뉴스 RSS를 가져올 수 없습니다. 네트워크나 프록시 서버 문제일 수 있습니다.");
                });
            });
        }
        
        fetchRss()
          .then(function (xmlText) {
            var parser = new DOMParser();
            var doc = parser.parseFromString(xmlText, "text/xml");
            var items = doc.querySelectorAll("item");
            var articles = [];
            var limit = Math.min(MAX_RESULTS, items.length);
            for (var i = 0; i < limit; i++) {
              var item = items[i];
              var titleEl = item.querySelector("title");
              var linkEl = item.querySelector("link");
              var descEl = item.querySelector("description");
              var pubEl = item.querySelector("pubDate");
              articles.push({
                title: titleEl ? titleEl.textContent.trim() : "",
                link: linkEl ? linkEl.textContent.trim() : "",
                summary: descEl ? descEl.textContent.trim() : "",
                published: pubEl ? pubEl.textContent.trim() : ""
              });
            }
            if (articles.length === 0) {
               // XML 파싱 실패 시 예외 처리
               throw new Error("RSS 데이터를 올바르게 읽지 못했습니다.");
            }
            showResult(keyword, articles);
          })
          .catch(function (err) {
            console.error(err);
            showMessage("뉴스를 가져오는 중 문제가 발생했어요. (" + err.message + ")", "error");
            document.getElementById("result").innerHTML = "";
          })
          .finally(function () {
            setLoading(false);
          });
      }

      function fetchArticleAndSummarize(link, summaryBlockEl, fallbackRssSummary) {
        summaryBlockEl.innerHTML = "<div class=\"label\">본문 기반 요약</div><p class=\"summary summary-loading\">본문을 읽고 요약하는 중…</p>";
        
        function fetchArticle() {
          var proxyUrl = getCorsProxy() + encodeURIComponent(link);
          return fetch(proxyUrl, { mode: 'cors', cache: 'no-cache' })
            .then(function (res) {
              if (!res.ok) throw new Error("HTTP " + res.status);
              return res.text();
            })
            .catch(function (err) {
              if (currentProxyIndex < CORS_PROXIES.length - 1) {
                tryNextProxy();
                return fetchArticle();
              }
              throw err;
            });
        }
        
        fetchArticle()
          .then(function (html) {
            var mainText = extractMainText(html);
            var summary = mainText ? extractiveSummarize(mainText, 3) : "";
            if (summary) {
              summaryBlockEl.innerHTML = "<div class=\"label\">본문 기반 요약</div><p class=\"summary\">" + escapeHtml(summary) + "</p>";
            } else {
              summaryBlockEl.innerHTML = "<div class=\"label\">요약</div><p class=\"summary\">" + escapeHtml(fallbackRssSummary || "본문에서 요약을 추출하지 못했습니다. 링크에서 직접 확인해 주세요.") + "</p>";
            }
          })
          .catch(function () {
            summaryBlockEl.innerHTML = "<div class=\"label\">요약</div><p class=\"summary summary-fail\">본문을 불러오지 못했습니다. RSS 요약: " + escapeHtml(fallbackRssSummary || "—") + "</p>";
          });
      }

      // ===== Gemini API 공통 호출 (서버 API 우선, 실패 시 클라이언트 키 사용) =====
      var GEMINI_API_ROUTE = "/api/gemini";

      function getApiKey() {
        var el = document.getElementById("apiKey");
        return el ? el.value.trim() : "";
      }

      function callGeminiViaServer(prompt, extraSystemText) {
        return fetch(GEMINI_API_ROUTE, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: prompt, extraSystemText: extraSystemText || "" })
        }).then(function (res) {
          return res.json().then(function (data) {
            if (res.ok && data.text !== undefined) return data.text;
            throw new Error(data.error || "서버 오류");
          });
        });
      }

      function callGeminiDirect(prompt, extraSystemText, retryCount) {
        retryCount = retryCount || 0;
        var maxRetries = 2;
        var apiKey = getApiKey();
        if (!apiKey) return Promise.reject(new Error("no_api_key"));

        var systemText = "당신은 한국어로 답변하는 뉴스 요약/설명 도우미입니다. 주어진 기사 정보만 기반으로 답하고, 모르는 내용은 모른다고 말하세요.";
        if (extraSystemText) systemText += "\n\n추가 지시: " + extraSystemText;

        var body = {
          contents: [{ parts: [{ text: prompt }] }],
          systemInstruction: { parts: [{ text: systemText }] }
        };

        function doFetch() {
          return fetch(GEMINI_API_URL + "?key=" + encodeURIComponent(apiKey), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });
        }

        function handleResponse(res) {
          if (res.ok) return res.json();
          return res.text().then(function (text) {
            var errorMsg = "Gemini API 오류 (상태: " + res.status + ")";
            var retrySeconds = null;
            try {
              var errData = JSON.parse(text);
              if (errData.error && errData.error.message) {
                errorMsg += ": " + errData.error.message;
                var match = (errData.error.message || "").match(/retry in (\d+(?:\.\d+)?)\s*s/i);
                if (match) retrySeconds = parseFloat(match[1]);
              } else errorMsg += ": " + text.substring(0, 200);
            } catch (e) { errorMsg += ": " + text.substring(0, 200); }
            var err = new Error(errorMsg);
            err.status = res.status;
            err.retrySeconds = retrySeconds;
            throw err;
          });
        }

        function parseResult(data) {
          if (data && data.error) throw new Error("Gemini API 오류: " + (data.error.message || JSON.stringify(data.error)));
          var text = data && data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text;
          return text || "";
        }

        return doFetch().then(handleResponse).then(parseResult).catch(function (err) {
          if (err.status === 429 && err.retrySeconds != null && retryCount < maxRetries) {
            return new Promise(function (resolve, reject) {
              setTimeout(function () { callGeminiDirect(prompt, extraSystemText, retryCount + 1).then(resolve).catch(reject); }, Math.min(err.retrySeconds * 1000, 60000));
            });
          }
          if (err.status === 429) err.message += "\n\n[할당량 초과] 잠시 후 다시 시도하세요.";
          throw err;
        });
      }

      function callGemini(prompt, extraSystemText) {
        return callGeminiViaServer(prompt, extraSystemText).catch(function (err) {
          if (getApiKey()) return callGeminiDirect(prompt, extraSystemText);
          throw new Error("서버 API를 사용할 수 없습니다 (로컬/오프라인). 상단에 Gemini API 키를 입력하거나, Vercel에 배포 후 Environment Variables에 GeminiAPIKey1을 설정하세요. 오류: " + (err.message || err));
        });
      }

      // ===== 기능 1: 전체 뉴스 요약 =====
      function handleAiSummary() {
        if (!currentArticles.length) {
          alert("먼저 키워드를 검색해 뉴스를 수집해 주세요.");
          return;
        }
        var btn = document.getElementById("aiSummaryBtn");
        var status = document.getElementById("aiSummaryStatus");
        var content = document.getElementById("aiSummaryContent");

        btn.disabled = true;
        status.textContent = "요약 생성 중...";
        content.textContent = "";

        var context = currentArticles.map(function (a, i) {
          return (
            "[" + (i + 1) + "] 제목: " + a.title +
            (a.published ? " / 날짜: " + a.published : "") +
            (a.summary ? " / RSS요약: " + stripHtml(a.summary) : "")
          );
        }).join("\n");

        var prompt =
          "키워드: " + currentKeyword + "\n" +
          "다음은 이 키워드로 수집한 뉴스 목록이다. 전체적인 흐름과 핵심 이슈를 한국어로 5문장 이내로 정리해 줘. " +
          "가능하면 소제목 없이 한 단락으로 써 줘.\n\n" +
          context;

        callGemini(prompt, "한국어로만 답변하세요.")
          .then(function (text) {
            content.textContent = text || "요약을 생성하지 못했습니다.";
          })
          .catch(function (err) {
            console.error("Gemini API 오류:", err);
            var errorMsg = err.message || "알 수 없는 오류";
            content.textContent = "AI 요약 중 오류가 발생했습니다.\n\n오류 내용: " + errorMsg + "\n\n확인 사항:\n1. API 키가 올바른지 확인\n2. 네트워크 연결 확인\n3. 브라우저 콘솔(F12)에서 자세한 오류 확인";
            content.style.color = "#dc2626";
          })
          .finally(function () {
            btn.disabled = false;
            status.textContent = "";
          });
      }

      // ===== 기능 2: 수집한 뉴스로 대화 =====
      function appendChatMessage(role, text) {
        var box = document.getElementById("chatMessages");
        var div = document.createElement("div");
        div.className = "chat-message " + (role === "user" ? "user" : "bot");
        div.textContent = text;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
      }

      function buildNewsContextForChat() {
        return currentArticles.map(function (a, i) {
          return (
            "[" + (i + 1) + "] 제목: " + a.title +
            (a.published ? " / 날짜: " + a.published : "") +
            (a.summary ? " / RSS요약: " + stripHtml(a.summary) : "")
          );
        }).join("\n");
      }

      function handleChatSend() {
        var input = document.getElementById("chatInput");
        var text = input.value.trim();
        if (!text) return;
        if (!currentArticles.length) {
          alert("먼저 키워드를 검색해 뉴스를 수집해 주세요.");
          return;
        }

        appendChatMessage("user", text);
        chatHistory.push({ role: "user", text: text });
        input.value = "";

        var btn = document.getElementById("chatSendBtn");
        btn.disabled = true;

        var newsContext = buildNewsContextForChat();
        var historyText = chatHistory.slice(-6).map(function (m) {
          return (m.role === "user" ? "사용자: " : "어시스턴트: ") + m.text;
        }).join("\n");

        var prompt =
          "다음은 키워드 '" + currentKeyword + "'로 수집한 뉴스 정보이다. 이 정보만을 기반으로 사용자 질문에 답해라. " +
          "추측해서 지어내지 말고, 기사에 없는 내용은 모른다고 말해라.\n\n" +
          "=== 뉴스 목록 ===\n" + newsContext + "\n\n" +
          "=== 최근 대화 ===\n" + historyText + "\n\n" +
          "위 정보를 바탕으로 마지막 사용자 질문에 답하라.";

        callGemini(prompt, "뉴스 내용과 사용자 질문만을 바탕으로, 짧고 명확하게 답하세요.")
          .then(function (answer) {
            var finalText = answer || "답변을 생성하지 못했습니다.";
            appendChatMessage("bot", finalText);
            chatHistory.push({ role: "assistant", text: finalText });
          })
          .catch(function (err) {
            console.error("Gemini API 오류:", err);
            var errorMsg = err.message || "알 수 없는 오류";
            appendChatMessage("bot", "AI 답변 중 오류가 발생했습니다.\n\n오류: " + errorMsg);
          })
          .finally(function () {
            btn.disabled = false;
          });
      }

      // ===== 기능 3: 키워드 & 뉴스 저장 =====
      function saveHistory(keyword, articles) {
        try {
          var raw = localStorage.getItem(STORAGE_KEY);
          var arr = raw ? JSON.parse(raw) : [];
          arr.unshift({
            keyword: keyword,
            at: new Date().toISOString(),
            articles: articles
          });
          if (arr.length > 20) arr = arr.slice(0, 20);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
        } catch (e) {
          console.warn("히스토리를 저장하지 못했습니다.", e);
        }
      }

      function renderHistory() {
        var list = document.getElementById("historyList");
        list.innerHTML = "";
        try {
          var raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          var arr = JSON.parse(raw);
          arr.slice(0, 10).forEach(function (item, idx) {
            var li = document.createElement("li");
            var date = new Date(item.at);
            var dateStr = date.toLocaleDateString() + " " + date.toLocaleTimeString();
            li.textContent = (idx + 1) + ". " + item.keyword + " (" + dateStr + ")";
            li.addEventListener("click", function () {
              document.getElementById("keyword").value = item.keyword;
              showResult(item.keyword, item.articles || []);
            });
            list.appendChild(li);
          });
        } catch (e) {
          console.warn("히스토리를 불러오지 못했습니다.", e);
        }
      }

      // 초기 히스토리 렌더링
      renderHistory();
    })();
  </script>
</body>
</html>